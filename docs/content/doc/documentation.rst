The Mise-à-la-masse method
==========================

Background
----------

The Mise-à-la-masse (MALM) method is a variation of the classical
electrical tomography map, for which the current is injected into the
ground by two electrodes of contrary sign and the potential is measured
between two mobile points.

MALM implementation is based on three assumptions:

#. the electrical conductivity of the root system body should be enough
   high to flow the current;

#. the conductor core should be continuous

#. and already located or exposed

The MALM forward operator
-------------------------

Voltage V depends on the density of current sources C according to
Poisson’s equation:

.. math:: \Delta \cdot (\sigma \Delta V) = C

where :math:`\sigma` is the conductivity of the medium, here assumed to
be defined by the conductivity distribution. The lattest is in general
obtained from an Electrical Resistivity Tomography (ERT) data inversion.

Green functions simulation
--------------------------

The first step consist in using Eq.\ `[eq:PoissonEq] <#eq:PoissonEq>`__
in order to forward simulate the voltage distribution generated by
individual point current sources placed in the medium, each representing
the possible location of current released.

In order to distinguish between the active sources used during the
prospection and the current sources used to generate the green functions
the latest are usually called virtual sources (VRTs).

The current Sources can be distributed on a regular grid of virtual
electrodes (VRTe) or an unstructured one. We hypothesized that the
number of locations for current sources, should be distributed in space
considering the prospection geometry i.e. the spatial distribution
(control by the distance between the electrode) and coverage.

The MALM forward simulation takes into account the electrical
conductivity :math:`\sigma` distribution generally known after ERT
inversion.

Problem linearisation
---------------------

The iCSD inversion that we propose here takes advantage of the physics
of the problem (i.e.,linearity and charge conservation) to decompose the
investigated CSD into the sum of point current sources. For linearity,
the potential field of multiple current sources is the sum of their
potential fields: the measured :math:`\Delta`\ V can be viewed as, and
decomposed into, the sum of multiple :math:`\Delta` V due to a set of
possible current sources :raw-latex:`\cite{LucaPlantAndSoil}`.

.. math:: Ax=b

Where :math:`\textbf{A}` is a matrix, its columns are the simulated VRTe
R sequences; x is a vector containing the unknown VRTe weights;
:math:`\textbf{b}` is a vector containing the measured sequence of
resistance. Each row in A corresponds to the relative R in the
acquisition sequence, e.g., :math:`\textbf{A}_{1,1}` is the first
resistance extracted from the potential field simulated with injection
at the first VRTe.

Including Constraints
~~~~~~~~~~~~~~~~~~~~~

The charge conservation is implemented by appending a row of 1’s to
:math:`\textbf{A}` and a corresponding 1 to the vector
:math:`\textbf{b}`. This forces the sum of the VRTe weights to be equal
to 1.

More in including constrainst in Menke W (1989) geophysical data
analysis: discrete inverse theory. International Geophysics Series.
Academic Press, New York.

Problem regularisation
----------------------

Data regularisation
~~~~~~~~~~~~~~~~~~~

In the algoritm current state the observations data can be weigted in
three different ways for which the weighted :math:`W_{d}` is equal to:

Model regularisation
~~~~~~~~~~~~~~~~~~~~

Prior informations
^^^^^^^^^^^^^^^^^^

The initial model :math:`\textbf{m}_{0}` vector is implemented using the
simple misfit between a single source current and the measured data:

.. math::

   \begin{aligned}
   \label{eq:PriorObjFct}
       F_{1,i}\left(d_{m},\ d_{f,i}\right)=\left\|d_{m}-d_{f,i}\right\|^{2}\end{aligned}

The goal of this step is to select “plausible” locations of current
release, to be then used as starting points for a regularized search of
the overall sources distribution (see step below). Each single current
location is given a score (named F1) depending on how well that single
source manages, alone, to explain the entire observed MALM voltage
distribution. Other approaches can be considered as a 1st attempt to
describe regions of influences without having to go trough a complete
inversion (see sect. ).

Spatial regularization
^^^^^^^^^^^^^^^^^^^^^^

-  For the 2d case, since the problem is undetermined a first order
   spatial regularization is added (Menke, 1989). Rows are added to
   express the differences between adjacent VRTe, e.g., the row
   :math:`\left[\begin{matrix}1&-1&\ldots\\\end{matrix}\right]`\ is the
   difference between the first two VRTe weights. The differences are
   added for the entire VRTe grid and set to 0 by adding corresponding
   0’s to b.

-  NEW: a second order spatial regularization with differentiation
   between x and y directions to obtain two different matrices (of the
   same size) such as :math:`D_{x}` and :math:`D_{y}`

-  NEW: for the 3d case, a k-mean with 4 (or more) neighbors sources
   regularization can be used. In that case each source is weighted so
   the sum is equal to 0.

We used a linear solver from Python library, using a least square
inversion which in the current version minimized the following objective
function:

.. math::

   \begin{aligned}
   \label{eq:ObjFctFull}
       \widetilde{\mathbit{m}}=\ min \left\{\left\|Lr\right\|^{2} + \lambda(\alpha_{s}\left\|m-m0\right\|^{2}+ \alpha_{x}\left\|D_{x}(m-m0)\right\|^{2} + \alpha_{z}\left\|D_{z}(m-m0)\right\|^{2})\right\}\end{aligned}

where :math:`\textbf{m}_{0}` is a reference model to which we believe
the physical property distribution should be close. Often
:math:`\textbf{m}_{0}` is chosen to be a constant average value. In that
case the initial model :math:`\textbf{m}_{0}` vector is implemented
using the simple misfit between a single source current and the measured
data:

Equation `[eq:ObjFctFull] <#eq:ObjFctFull>`__ also contains the
coefficients controlling weight of the relative smallness
:math:`\alpha_{s}`, and the regularization anisotropy wieigth
:math:`\alpha_{x}` and :math:`\alpha_{y}`\ respectively in x and y
directions.

::


   from icsd3d_class import iCSD3d_Class as i3d

   [...]

   # use relative smallness model reg
   id3d.x0_prior=True 
   id3d.alphax0=1 # weight of relative smallness
   # use anisotropic smoothing regularisation fct
   id3d.alphaSxy=True 
   id3d.alphaSx=1 # x-smooth
   id3d.alphaSy=1 # y-smooth
       

Equation `[eq:ObjFctFull] <#eq:ObjFctFull>`__ can be rewritten as:

.. math::

   \begin{aligned}
   \label{eq:ObjFct2}
   \widetilde{m}=\ min\left\{{(Gm-d)}^TW_d(Gm-d)\ +\ \lambda{(m-m_0)}^{T}W_m(m-m_0)\right\}\end{aligned}

Where

.. math::

   \begin{aligned}
   \label{eq:Wd}
   W_{d}=L^{T}L\end{aligned}

The trade-off between data misfit and solution regularization is
controlled by :math:`\lambda`. The numerical routine includes a “pareto”
functionality wherein regularization and model-to-measurement fit are
traded off while changing the regularization weight. The obtained set of
solutions can be used to construct the “pareto front” (L-curve), which
is a widely accepted way to estimate the optimum regularization weight
:raw-latex:`\cite{hansen1993insect}`.

The solution is further constrained by forcing the linear solver to seek
only positive VRTe weights (i.e., inequality constraint), as the
negative source of current is known to correspond uniquely to the return
electrode. The following equation can be use to solve the inversion
problem:

.. math::

   \begin{aligned}
   \label{eq:m}
   m={(G^{T}W_{d}G\ +\ \lambda W_{m})}^{-1}(G^{T}W_{d}d\ +\ \lambda W_{m}m_{0})\end{aligned}

by solving the system Am=b, with:

.. math::

   \begin{aligned}
   \label{eq:Aside}
   A=(G^{T}W_{d}G\ +\ \lambda W_{m})\end{aligned}

.. math::

   \begin{aligned}
   \label{eq:Bside}
   b=(G^{T}W_{d}d\ +\ \lambda W_{m}m_{0})\end{aligned}

Model appraisal
---------------

TO WRITE

.. _ssec:OthersApproaches:

Other approaches
----------------

TO WRITE: vraisemblance fct from Binley’s article cite binley paper

:raw-latex:`\cite{binley1997detecting}`
